<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">lib/database-setup-query-builder.js | electron-RxDB API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/database-change-record.js~DatabaseChangeRecord.html">DatabaseChangeRecord</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/database-transaction.js~DatabaseTransaction.html">DatabaseTransaction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/json-blob.js~JSONBlob.html">JSONBlob</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/mutable-query-result-set.js~MutableQueryResultSet.html">MutableQueryResultSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/mutable-query-subscription.js~MutableQuerySubscription.html">MutableQuerySubscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/query-range.js~QueryRange.html">QueryRange</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/query-result-set.js~QueryResultSet.html">QueryResultSet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/query-subscription.js~QuerySubscription.html">QuerySubscription</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/query.js~ModelQuery.html">ModelQuery</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/rx-database.js~RxDatabase.html">RxDatabase</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-logSQLString">logSQLString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateTempId">generateTempId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-isTempId">isTempId</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-modelFreeze">modelFreeze</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-tableNameForJoin">tableNameForJoin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">attributes</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-boolean.js~AttributeBoolean.html">AttributeBoolean</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-collection.js~AttributeCollection.html">AttributeCollection</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-datetime.js~AttributeDateTime.html">AttributeDateTime</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-joined-data.js~AttributeJoinedData.html">AttributeJoinedData</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-number.js~AttributeNumber.html">AttributeNumber</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-object.js~AttributeObject.html">AttributeObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute-string.js~AttributeString.html">AttributeString</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/attribute.js~Attribute.html">Attribute</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/matcher.js~Matcher.html">Matcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/attributes/sort-order.js~SortOrder.html">SortOrder</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">browser</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/browser/coordinator.js~Coordinator.html">Coordinator</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/database-setup-query-builder.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/* eslint global-require:0 */
import ModelRegistry from &apos;./model-registry&apos;;
import {tableNameForJoin} from &apos;./utils&apos;;
import Attributes from &apos;./attributes&apos;;

const {AttributeCollection, AttributeJoinedData} = Attributes;

/**
The factory methods in this class assemble SQL queries that build Model
tables based on their attribute schema.

@private
*/
export default class DatabaseSetupQueryBuilder {

  setupQueries() {
    let queries = []
    for (const klass of ModelRegistry.getAllConstructors()) {
      queries = queries.concat(this.setupQueriesForTable(klass));
    }
    return queries;
  }

  analyzeQueries() {
    const queries = [];

    for (const klass of ModelRegistry.getAllConstructors()) {
      const attributes = Object.keys(klass.attributes).map(k =&gt; klass.attributes[k]);
      const collectionAttributes = attributes.filter((attr) =&gt;
        attr.queryable &amp;&amp; attr instanceof AttributeCollection
      )

      queries.push(`ANALYZE \`${klass.name}\``);
      collectionAttributes.forEach((attribute) =&gt; {
        queries.push(`ANALYZE \`${tableNameForJoin(klass, attribute.itemClass)}\``)
      });
    }
    return queries;
  }

  setupQueriesForTable(klass) {
    const attributes = Object.keys(klass.attributes).map(k =&gt; klass.attributes[k]);
    let queries = [];

    // Identify attributes of this class that can be matched against. These
    // attributes need their own columns in the table
    const columnAttributes = attributes.filter(attr =&gt;
      attr.queryable &amp;&amp; attr.columnSQL &amp;&amp; attr.jsonKey !== &apos;id&apos;
    );

    const columns = [&apos;id TEXT PRIMARY KEY&apos;, &apos;data BLOB&apos;]
    columnAttributes.forEach(attr =&gt; columns.push(attr.columnSQL()));

    const columnsSQL = columns.join(&apos;,&apos;);
    queries.unshift(`CREATE TABLE IF NOT EXISTS \`${klass.name}\` (${columnsSQL})`);
    queries.push(`CREATE UNIQUE INDEX IF NOT EXISTS \`${klass.name}_id\` ON \`${klass.name}\` (\`id\`)`);

    // Identify collection attributes that can be matched against. These require
    // JOIN tables. (Right now the only one of these is Thread.folders or
    // Thread.categories)
    const collectionAttributes = attributes.filter(attr =&gt;
      attr.queryable &amp;&amp; attr instanceof AttributeCollection
    );
    collectionAttributes.forEach((attribute) =&gt; {
      const joinTable = tableNameForJoin(klass, attribute.itemClass);
      const joinColumns = attribute.joinQueryableBy.map((name) =&gt;
        klass.attributes[name].columnSQL()
      );
      joinColumns.unshift(&apos;id TEXT KEY&apos;, &apos;`value` TEXT&apos;);

      queries.push(`CREATE TABLE IF NOT EXISTS \`${joinTable}\` (${joinColumns.join(&apos;,&apos;)})`);
      queries.push(`CREATE INDEX IF NOT EXISTS \`${joinTable.replace(&apos;-&apos;, &apos;_&apos;)}_id\` ON \`${joinTable}\` (\`id\` ASC)`);
      queries.push(`CREATE UNIQUE INDEX IF NOT EXISTS \`${joinTable.replace(&apos;-&apos;, &apos;_&apos;)}_val_id\` ON \`${joinTable}\` (\`value\` ASC, \`id\` ASC)`);
    });

    const joinedDataAttributes = attributes.filter(attr =&gt;
      attr instanceof AttributeJoinedData
    )

    joinedDataAttributes.forEach((attribute) =&gt; {
      queries.push(`CREATE TABLE IF NOT EXISTS \`${attribute.modelTable}\` (id TEXT PRIMARY KEY, \`value\` TEXT)`);
    });

    if (klass.additionalSQLiteConfig &amp;&amp; klass.additionalSQLiteConfig.setup) {
      queries = queries.concat(klass.additionalSQLiteConfig.setup());
    }

    if (klass.searchable === true) {
      queries.push(this.createSearchIndexSql(klass));
    }

    return queries;
  }

  createSearchIndexSql(klass) {
    if (!klass) {
      throw new Error(`RxDatabase::createSearchIndex - You must provide a class`);
    }
    if (!klass.searchFields) {
      throw new Error(`RxDatabase::createSearchIndex - ${klass.name} must expose an array of \`searchFields\``);
    }
    const searchTableName = `${klass.name}Search`;
    const searchFields = klass.searchFields;
    return (
      `CREATE VIRTUAL TABLE IF NOT EXISTS \`${searchTableName}\` ` +
      `USING fts5(
        tokenize=&apos;porter unicode61&apos;,
        content_id UNINDEXED,
        ${searchFields.join(&apos;, &apos;)}
      )`
    );
  }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
